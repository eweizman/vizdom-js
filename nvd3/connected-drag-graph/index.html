<html>
<head>
    <title>NVD3 Example Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
    <link href="nv.d3.css" rel="stylesheet">
    <script src="nv.d3.js"></script>
</head>
<body id="body">

    <div id="header_buttons"></div>

    <script>

    Object.size = function(obj) {
        var size = 0, key;
        for (key in obj) {
            if (obj.hasOwnProperty(key)) size++;
        }
        return size;
    };

    addHeaderSelector();
    var charts  = {};
    var chartConnections = {};
    var filters = {};
    var selected = {};
    var csv = "data/fakedata.csv";

    function addHeaderSelector() {
        var csv = "data/fakedata.csv";
        d3.csv(csv, function(error, data) {
            keys = d3.keys(data[0]);
            for (i in keys) {
                var key = keys[i];
                var button = document.createElement("button");
                button.appendChild(document.createTextNode(key));
                button.setAttribute("type", "button");
                button.setAttribute("draggable", "true");
                button.setAttribute("ondragstart", "drag(event)");
                var div = document.getElementById("header_buttons");
                div.appendChild(button);
            }
            document.body.addEventListener('drop', drop, false);
            document.body.addEventListener('dragover', dragOver, false);
        });
    }

    function newGraph(x,y,key) {
        var chartId = "chart" + (Object.size(charts) + 1);
        charts[chartId] = "";
        chartConnections[chartId] = [];
        var newGraphDiv = document.createElement("div");
        newGraphDiv.setAttribute("id", chartId);

        newGraphDiv.setAttribute("style", "position:absolute; TOP:"+y+"px; LEFT:"+x+"px");

        var svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
        svg.setAttribute('xmlns:xlink','http://www.w3.org/1999/xlink');
        newGraphDiv.appendChild(svg);

        newGraphDiv.setAttribute("draggable", "true");
        newGraphDiv.setAttribute("ondragstart", "dragChart(event)");
        newGraphDiv.addEventListener("drop", dropChartFromChartId(chartId), false);

        var body = document.getElementById("body");
        var newGraphButton = document.getElementById("newGraphButton");

        body.insertBefore(newGraphDiv, newGraphButton);

        createGraph(chartId, key);
    }

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function dragOver(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("type", "newGraph");
        ev.dataTransfer.setData("text", ev.target.firstChild.nodeValue);
    }

    function dragChart(ev) {
        ev.dataTransfer.setData("type", "dragChart");
        ev.dataTransfer.setData("chartId", ev.target.id);
    }

    function drop(ev) {
        ev.preventDefault();
        var x = ev.pageX, y = ev.pageY;

        switch(ev.dataTransfer.getData("type")) {
            case "newGraph" :
            var data = ev.dataTransfer.getData("text");
            newGraph(x, y, data);
            break;
            default :
            break;
        }
    }

    function dropChartFromChartId(chartId2) {
        return function(ev) {
            ev.preventDefault();
            switch(ev.dataTransfer.getData("type")) {
                case "dragChart" :
                var chartId1 = ev.dataTransfer.getData("chartId");
                connectGraph(chartId1, chartId2);
                break;
                default :
                break;
            }
        }
    }

    function connectGraph(source, dest) {
        if (source == dest || chartConnections[source].indexOf(dest) > -1) {
            return;
        }
        chartConnections[source].push(dest);
        if (source in selected) {

            filterDownstreamChart(source, dest, selected[source].key, selected[source].val, true);
        }
    }

    function createGraph(chartId, key) {
        createGraphFromKey(key, chartId, {});
        charts[chartId] = key;
    }

    function createGraphFromKey(key, chartId, filterKeys) {
        var chartNum = '#'+chartId+" svg";
        d3.csv(csv, function(error, data){
            var group = d3.nest()
            .key(function(d) {return d[key]})
            .rollup(function(d) {
                return d3.sum(d, function(g) {
                    for (var key in filterKeys) {
                        if (g[key] != filterKeys[key]) {
                            return 0;
                        }
                    }
                    return 1
                });
            }).entries(data);

            group.forEach(function(d) {
                d.label = d.key;
                d.value = d.values;
            })

            var exampleData = [
            {
                key: "totals",
                values: group
            }
            ];

            nv.addGraph(function() {
                var width = 400, height = 300;
                var chart = nv.models.discreteBarChart()
                .x(function(d) { return d.label })
                .y(function(d) { return d.value })
                .staggerLabels(true)
                .showValues(true)
                .duration(250)
                .width(width)
                .height(height)
                ;
                d3.select(chartNum)
                .datum(exampleData)
                .call(chart)
                .style({'width':width, 'height':height});

                function titleDrag(d) {
                    var x = d3.event.x;
                    var y = d3.event.y;
                    var chartDiv = document.getElementById(chartId);
                    var top = chartDiv.offsetTop;
                    var left = chartDiv.offsetLeft - width/2;
                    chartDiv.setAttribute("style", "position:absolute; TOP:"+ (top + y)+"px; LEFT:"+(left + x)+"px");
                }

                var drag = d3.behavior.drag()
                .on("drag", titleDrag);

                d3.select(chartNum)
                .append("text")
                .attr("x", width/2)
                .attr("y", 11)
                .attr("text-anchor", "middle")
                .attr("class", "chart-title")
                .text(chartId + " ("+key+")")
                .call(drag);

                if (chartId in selected) {
                    d3.select(selected[chartId].bar).style("fill", "red");
                }

                nv.utils.windowResize(chart.update);
                return chart;
            }, function () {
                d3.selectAll(chartNum + " .nv-bar").on('mousedown', function(d) {
                    onBarSelection(chartId, this, key, d.key);

                });
            });
});
}

function onBarSelection(chartId, bar, key, val) {
        //Determine whether the bar is being selected or deselected
        var isSelected;
        if (chartId in selected) {
            isSelected = selected[chartId].val != val;
        } else {
            isSelected = true;
        }

        deselectSelected(chartId);

        if (isSelected) {
                        //Return previously selected bar to red color
                        emphasizeSelectedBar(chartId, bar, key, val);
                    } else {
                        delete selected[chartId];
                    }

                    //Find all those charts downstream to current chart
                    for (charti in chartConnections[chartId]) {
                        var chartId2 = chartConnections[chartId][charti];
                        filterDownstreamChart(chartId, chartId2, key, val, isSelected);
                   }
               }

            function filterDownstreamChart(chartId, chartId2, key, val, isSelected) {
                //var chart2Key = charts[chartId2];

                //Add currently selected item to filter of downstream chart
                var filter;
                if (!(chartId2 in filters)) {
                    filters[chartId2] = {};
                }
                filter = filters[chartId2];

                //prevent infinite loops if charts are parents and children of each other
                if (isSelected && filter[key] == val) {
                    //return;
                }
                if (isSelected) {
                    propogateFiltersDownward(chartId, chartId2, key, val);
                } else {
                    propogateDeselectionDownwards(chartId2, key);
                }

                propogateGraphCreationDownwards(chartId2);
                
                /*filter = filters[chartId2];
                if (chart2Key != "") {
                   createGraphFromKey(chart2Key, chartId2, filter);
               }*/
            }

            function propogateGraphCreationDownwards(chartId) {
                for (var i=0;i<chartConnections[chartId].length;i++) {
                    var chartId2 = chartConnections[chartId][i];
                    propogateGraphCreationDownwards(chartId2);
                }

                var filter = filters[chartId];
                var key = charts[chartId];
                if (key != "") {
                    createGraphFromKey(key, chartId, filter);
                }
            }

            function propogateFiltersDownward(chartId, chartId2, key, val) {
                if (!(chartId2 in filters)) {
                    filters[chartId2] = {};
                }
                filter = filters[chartId2];

                if (chartId == chartId2 || filter[key] == val) {
                    return;
                }

                for (var i=0;i<chartConnections[chartId2].length;i++) {
                    var chartId3 = chartConnections[chartId2][i];
                    propogateFiltersDownward(chartId2, chartId3, key, val);
                }

                //make sure all filters that are applied to upstream chart get applied to downstream chart as well
                for (var filterKey in filters[chartId]) {
                    filter[filterKey] = filters[chartId][filterKey];
                }
                filters[chartId2][key] = val;
            }

            function propogateDeselectionDownwards(chartId, key) {
                if (! chartId in filters || ! chartId in chartConnections) {
                    return;
                }
                for (var i=0;i<chartConnections[chartId].length;i++) {
                    var chartId2 = chartConnections[chartId][i];
                    propogateDeselectionDownwards(chartId2, key);
                }
                delete filters[chartId][key];
            }

            function emphasizeSelectedBar(chartId, bar, key, val) {
                selected[chartId] = {key:key, val:val, bar:bar, color:d3.select(bar).style("fill")};
                d3.select(bar).style("fill", "red");
            }

            function deselectSelected(chartId) {
                if (chartId in selected) {
                    d3.select(selected[chartId].bar).style("fill", selected[chartId].color);
                }
            }

            </script>
        </body>
        </html>