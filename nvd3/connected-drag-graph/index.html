<html>
<head>
    <title>NVD3 Example Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
        <link href="nv.d3.css" rel="stylesheet">
    <script src="nv.d3.js"></script>
</head>
<body id="body">

    <div id="header_buttons"></div>

<script>

Object.size = function(obj) {
    var size = 0, key;
    for (key in obj) {
        if (obj.hasOwnProperty(key)) size++;
    }
    return size;
};

addHeaderSelector();
var charts  = {};
var csv = "data/fakedata.csv";

function addHeaderSelector() {
    var csv = "data/fakedata.csv";
    d3.csv(csv, function(error, data) {
    keys = d3.keys(data[0]);
    for (i in keys) {
            var key = keys[i];
            var button = document.createElement("button");
            button.appendChild(document.createTextNode(key));
            button.setAttribute("type", "button");
            button.setAttribute("draggable", "true");
            button.setAttribute("ondragstart", "drag(event)");
            var div = document.getElementById("header_buttons");
            div.appendChild(button);
    }
    document.body.addEventListener('drop', drop, false);
    document.body.addEventListener('dragover', dragOver, false);
    });
}

function newGraph(x,y,key) {
    var chartId = "chart" + (Object.size(charts) + 1);
    charts[chartId] = "";
    var newGraphDiv = document.createElement("div");
    newGraphDiv.setAttribute("id", chartId);

    newGraphDiv.setAttribute("style", "position:absolute; TOP:"+y+"px; LEFT:"+x+"px");

    //var svg = document.createElement("svg");
    var svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('xmlns:xlink','http://www.w3.org/1999/xlink');
    newGraphDiv.appendChild(svg);

    var body = document.getElementById("body");
    var newGraphButton = document.getElementById("newGraphButton");

    body.insertBefore(newGraphDiv, newGraphButton);

    createGraph(chartId, key);
}

function allowDrop(ev) {
    ev.preventDefault();
}

function dragOver(ev) {
    ev.preventDefault();
}

function drag(ev) {
    console.log(ev.target.firstChild.nodeValue);
    ev.dataTransfer.setData("text", ev.target.firstChild.nodeValue);
}

function drop(ev) {
    ev.preventDefault();
    var data = ev.dataTransfer.getData("text");
    console.log(ev);
    newGraph(ev.clientX, ev.clientY, data);
}

function createGraph(chartId, key) {
    createGraphFromKey(key, '#'+chartId+" svg", {});
    charts[chartId] = key;
}

    function createGraphFromKey(key, chartNum, filterKeys) {
        d3.csv(csv, function(error, data){
            var group = d3.nest()
            .key(function(d) {return d[key]})
            .rollup(function(d) {
                return d3.sum(d, function(g) {
                    for (var key in filterKeys) {
                        if (g[key] != filterKeys[key]) {
                            return 0;
                        }
                    }
                    return 1
                });
            }).entries(data);

            group.forEach(function(d) {
                d.label = d.key;
                d.value = d.values;
            })

            var exampleData = [
            {
                key: "totals",
                values: group
            }
            ];

            nv.addGraph(function() {
                var width = 400, height = 300;
                var chart = nv.models.discreteBarChart()
                .x(function(d) { return d.label })
                .y(function(d) { return d.value })
                .staggerLabels(true)
                .showValues(true)
                .duration(250)
                .width(width)
                .height(height)
                ;
                d3.select(chartNum)
                .datum(exampleData)
                .call(chart)
                .style({'width':width, 'height':height});
                nv.utils.windowResize(chart.update);
                return chart;
            }, function () {
                d3.selectAll(chartNum + " .nv-bar").on('mousedown', function(d) {
                if (chartNum.indexOf('1') > -1) {
                    filter = {};
                    filter[key] = d.key;
                    for (chart in charts) {
                        if (chart != "chart1" && charts[chart] != "") {
                            createGraphFromKey(charts[chart], '#'+chart+' svg', filter);
                        }
                    }                    
                }
                
            });
        });
        });
    }

</script>
</body>
</html>